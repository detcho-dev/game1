<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± - Ù†Ø³Ø®Ø© Ø§Ù„ÙˆÙŠØ¨</title>
  <style>
    :root{
      --bg:#0f1115; --pane:#171a21; --muted:#8892a6; --fg:#e6edf3; --accent:#3b82f6; --ok:#22c55e; --warn:#eab308; --bad:#ef4444; --card:#1f2430; --line:#2b3242;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans Arabic","Noto Kufi Arabic",Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";}
    .container{display:flex;flex-direction:column;height:100vh}
    .panel{flex:1;min-height:0;padding:16px;border-top:1px solid var(--line)}
    .top{background:var(--pane)}
    .bottom{background:var(--card)}
    @media(min-width:768px){ .container{flex-direction:row} .panel{border-top:none;border-left:1px solid var(--line)} .top{border-left:none}}
    h1,h2,h3{margin:0 0 8px}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#2b3242;color:var(--fg);transition:.15s}
    .btn:hover{filter:brightness(1.1)}
    .btn-primary{background:var(--accent)}
    .btn-ok{background:var(--ok)}
    .btn-warn{background:var(--warn);color:#111}
    .btn-bad{background:var(--bad)}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#12151c;color:var(--fg)}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .card{background:#141821;border:1px solid var(--line);border-radius:14px;padding:12px}
    .offer{background:#121721;border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
    .log{height:220px;overflow:auto;background:#0e121a;border:1px solid var(--line);border-radius:12px;padding:12px;font-size:14px}
    .stat{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:#12171f;border:1px solid var(--line)}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr}
    @media(min-width:768px){.grid-2{grid-template-columns:1fr 1fr}}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f1420;border:1px solid var(--line);font-size:12px;margin:2px 0}
    .footerbar{position:sticky;bottom:0;margin-top:10px;padding:10px;border-top:1px solid var(--line);background:#0b0e14;border-radius:12px}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .kpi .pill{font-weight:600}
    .list{margin:0;padding-inline-start:18px}
  </style>
</head>
<body>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginView" class="container">
    <div class="panel top">
      <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
      <p class="muted">Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¨ØªØ³Ø¬Ù„ Ù‡ØªØªØ³Ø¬Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¯ÙŠ).</p>
      <div class="card grid grid-2">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="username" placeholder="Ù…Ø«Ø§Ù„: joe" />
        </div>
        <div>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
      </div>
      <div class="stack" style="margin-top:10px">
        <button class="btn btn-primary" onclick="loginFlow()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" onclick="clearSession()">Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      </div>
    </div>
    <div class="panel bottom">
      <h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <ul class="list muted">
        <li>Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (<code>localStorage</code>).</li>
        <li>Ù…Ù…ÙƒÙ† ØªØ±Ø¬Ø¹ ÙŠÙˆÙ…Ùƒ Ù…Ù† ØºÙŠØ± Ù…Ø§ ØªÙÙ‚Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù….</li>
      </ul>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
  <div id="gameView" class="container" style="display:none">
    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© + Ø£ØµÙˆÙ„ÙŠ -->
    <div class="panel top">
      <h2>Ø£Ù‡Ù„Ù‹Ø§ØŒ <span id="playerName"></span></h2>

      <div class="grid grid-2" style="margin-top:10px">
        <div class="stat">ğŸ“… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="day" style="margin-inline-start:6px">1</b></div>
        <div class="stat">ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <b id="balance" style="margin-inline-start:6px">1000</b> $</div>
      </div>

      <div class="card" style="margin-top:10px">
        <h3>ğŸ“¦ Ø£Ù…Ù„Ø§ÙƒÙŠ</h3>
        <div id="assetsEmpty" class="muted">Ù„Ø³Ù‡ Ù…Ø§ Ø§Ø´ØªØ±ÙŠØªØ´ Ø­Ø§Ø¬Ø©.</div>
        <div id="assetsList"></div>
        <div class="stack" style="margin-top:8px">
          <button class="btn" onclick="mergePropertiesUI()">Ø¯Ù…Ø¬ Ø§Ù„Ø°Ù‡Ø¨</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <h3>ğŸ“ˆ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„ÙŠÙˆÙ…</h3>
        <div id="marketPills" class="kpi"></div>
      </div>

      <div class="footerbar">
        <div class="kpi">
          <span class="pill">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø§Ù„ÙŠÙˆÙ…: <b id="offersLeft">0</b></span>
          <span class="pill">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„ØªØ§Ù„ÙŠ: <b id="nextEvent">â€”</b></span>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¹Ø±ÙˆØ¶ + Ø§Ù„Ù„ÙˆØ¬ -->
    <div class="panel bottom">
      <div class="stack">
        <button id="newEventBtn" class="btn btn-primary" onclick="triggerNextEvent()">Ø¹Ø±Ø¶/Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>

      <div id="offerArea"></div>

      <div class="card" style="margin-top:12px">
        <h3>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
        <div id="eventLog" class="log"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   ØªØ·Ø§Ø¨Ù‚ Ø¯ÙˆØ§Ù„ Ø¨Ø§ÙŠØ«ÙˆÙ† Ù…Ø¹ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª
   ========================= */

// units ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
const units = {
  land: 'meters',
  property: 'units',
  gold: 'grams',
  factory: 'factories',
  company: 'shares',
  island: 'islands'
};

// 1) print_pause -> printPause
function printPause(message, delay=2000){ return message; }

// 2) load_users -> loadUsers (Ù…Ù† localStorage)
function loadUsers(){
  try{ return JSON.parse(localStorage.getItem('users')||'{}'); }
  catch{ return {}; }
}

// 3) save_users -> saveUsers
function saveUsers(obj){ localStorage.setItem('users', JSON.stringify(obj)); }

// 4) get_user -> getUser
function getUser(username){
  const users = loadUsers();
  if(!users[username]){
    users[username] = {
      password: null,
      balance: 1000,
      day: 1,
      properties: [],
      event_log: []
    };
    saveUsers(users);
  }
  return users[username];
}

// 5) update_user -> updateUser
function updateUser(username, data){
  const users = loadUsers();
  users[username] = data;
  saveUsers(users);
}

// 6) login(username) ÙÙŠ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† ÙƒØ§Ù†Øª Ø¨ØªØªØ­Ù‚Ù‚ Ù„Ùˆ ÙÙŠÙ‡ Ø¨Ø§Ø³ÙˆØ±Ø¯
function loginUser(username){ 
  const u = getUser(username);
  return u.password ? u : null;
}

// 7) daily_income -> dailyIncome
function dailyIncome(username){
  const user = getUser(username);
  const base_income = 100;
  const bonus = user.properties.length * 50;
  const income = base_income + bonus;
  user.balance += income;
  user.event_log.push(`ğŸ’° Daily income: $${income} (Base $${base_income} + $${bonus} bonus)`);
  user.day += 1;
  updateUser(username, user);
  return `Daily income: $${income}. Balance: $${user.balance}`;
}

/* ===== Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ø´ Ù…ÙŠØªØ© ===== */
const market = {
  land: 1, property: 1, gold: 1, factory: 1, company: 1, island: 1
};
function randomIn(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function vary(f, pct=0.2){ // Â±20%
  const delta = (Math.random()*2-1)*pct;
  return Math.max(0.6, Math.min(1.6, f*(1+delta)));
}
function rollNewMarket(){
  // ÙƒÙ„ ÙŠÙˆÙ… Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³ÙˆÙ‚
  market.land = vary(market.land);
  market.property = vary(market.property);
  market.gold = vary(market.gold, 0.3);
  market.factory = vary(market.factory);
  market.company = vary(market.company, 0.25);
  market.island = vary(market.island, 0.15);
  renderMarket();
}

/* 8) get_offer -> getOffer (ØªØ±Ø¬Ø¹ msg + data) */
function getOffer(){
  const types = ['land','property','gold','factory','company','island'];
  const ttype = types[Math.floor(Math.random()*types.length)];
  if (ttype === 'land'){
    const price = randomIn(100,500) * market.land;
    return [`Land offer: Buy 1 plot for $${Math.floor(price)}`, {type:ttype, price:Math.floor(price)}];
  }
  if (ttype === 'property'){
    const price = randomIn(500,2000) * market.property;
    return [`Property offer: Buy 1 unit for $${Math.floor(price)}`, {type:ttype, price:Math.floor(price)}];
  }
  if (ttype === 'gold'){
    const grams = randomIn(10,100);
    const ppg = randomIn(50,100) * market.gold;
    const total = Math.floor(grams * ppg);
    return [`Gold offer: ${grams}g at $${Math.floor(ppg)}/g for total $${total}`, {type:'gold', grams, price_per_gram:Math.floor(ppg), price:total}];
  }
  if (ttype === 'factory'){
    const capacity = randomIn(1,5);
    const price = Math.floor(capacity * randomIn(1000,5000) * market.factory);
    return [`Factory offer: capacity ${capacity} for $${price}`, {type:ttype, capacity, price}];
  }
  if (ttype === 'company'){
    const shares = randomIn(10,50);
    const pps = Math.floor(randomIn(200,500) * market.company);
    const total = shares * pps;
    return [`Company offer: ${shares} shares at $${pps}/share for total $${total}`, {type:ttype, shares, price_per_share:pps, price:total}];
  }
  // island
  const size = ['small','medium','large'][Math.floor(Math.random()*3)];
  const mult = {small:500, medium:2000, large:5000}[size];
  const price = Math.floor(mult * randomIn(1,3) * market.island);
  return [`Island offer: Buy a ${size} island for $${price}`, {type:'island', size, price}];
}

/* 9) merge_properties -> mergeProperties */
function mergeProperties(username){
  const user = getUser(username);
  const merged = [];
  let gold_total = 0, gold_spent = 0;
  for(const item of user.properties){
    if(item.type==='gold'){
      gold_total += item.grams||0;
      gold_spent += item.spent||0;
    }else{
      merged.push(item);
    }
  }
  if(gold_total){
    merged.push({type:'gold', grams:gold_total, spent:gold_spent});
  }
  user.properties = merged;
  updateUser(username, user);
}

/* 10) handle_offer -> handleOffer (ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ù†Ø·Ù‚Ùƒ Ø¨Ù…Ø§ ÙÙŠÙ‡ Ø§Ù„ØªÙØ§ÙˆØ¶=Ø´Ø±Ø§Ø¡ Ø¨Ø³Ø¹Ø± Ù…Ø®ÙÙ‘Ø¶) */
function handleOffer(username, data, choice){
  const user = getUser(username);
  let price = data.price;
  if (choice === 'negotiate'){
    const new_price = Math.floor(price * (1 - randomIn(5,30)/100));
    choice = 'yes';
    price = new_price;
    user.event_log.push(`ğŸ¤ Negotiated price to $${price}`);
  }
  if (choice === 'yes'){
    if (user.balance >= price){
      user.balance -= price;
      let exists = false;
      for (const item of user.properties){
        if (item.type === data.type){
          if (data.type === 'gold') item.grams = (item.grams||0) + (data.grams||0);
          else if (data.type === 'company') item.shares = (item.shares||0) + (data.shares||0);
          else if (data.type === 'factory') item.capacity = (item.capacity||0) + (data.capacity||0);
          else item.quantity = (item.quantity||0) + 1;
          item.spent = (item.spent||0) + price;
          exists = true;
        }
      }
      if(!exists){
        const entry = {type:data.type, spent:price};
        if (data.type==='gold') entry.grams = data.grams;
        else if (data.type==='company') entry.shares = data.shares;
        else if (data.type==='factory') entry.capacity = data.capacity;
        else entry.quantity = 1;
        user.properties.push(entry);
      }
      user.event_log.push(`âœ… Bought ${data.type} for $${price}`);
      updateUser(username, user);
      return `Purchased! New balance: $${user.balance}`;
    }else{
      user.event_log.push(`âŒ You don't have enough balance.`);
      updateUser(username, user);
      return `You don't have enough balance.`;
    }
  }else{
    user.event_log.push(`ğŸš« No purchase made.`);
    updateUser(username, user);
    return `No purchase made.`;
  }
}

/* 11) get_daily_events -> getDailyEvents */
function getDailyEvents(){
  const count = randomIn(2,5);
  const types = ['offer','sell','auction'];
  const out = [];
  for(let i=0;i<count;i++){
    out.push(types[randomIn(0,types.length-1)]);
  }
  return out;
}

/* =========================
   ÙˆØ§Ø¬Ù‡Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
   ========================= */

let sessionUser = null;
let eventsToday = [];   // Ù‚Ø§Ø¦Ù…Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ…
let currentEvent = null;// { kind:'offer'|'sell'|'auction', payload:{} }
let pendingOffer = null;// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„Ø´Ø±Ø§Ø¡/Ø§Ù„ØªÙØ§ÙˆØ¶/Ø§Ù„Ø±ÙØ¶)

function loginFlow(){
  const uname = document.getElementById('username').value.trim();
  const pass  = document.getElementById('password').value;
  if(!uname){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); return; }

  let u = getUser(uname); // ÙŠØ±Ø¬Ø¹ user Ø£Ùˆ ÙŠÙ†Ø´Ø¦ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
  if(u.password && u.password !== pass){ 
    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); 
    return; 
  }

  if(!u.password){ 
    u.password = pass; 
    updateUser(uname, u); 
  }

  sessionUser = uname;
  localStorage.setItem('sessionUser', uname);

  // ğŸ‘‡ Ø§ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§ØªØ­Ø¯Ø«Øª Ù…Ù† localStorage Ù‚Ø¨Ù„ Ù…Ø§ ØªÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø©
  u = getUser(uname);

  showGame();
}


function showGame(){
  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ø¥Ø¹Ø¯Ø§Ø¯ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ù„Ùˆ Ù„Ø³Ù‡ Ù…ÙÙŠØ´
  const u = getUser(sessionUser);
  document.getElementById('playerName').textContent = sessionUser;

  // Ø§Ø¨Ø¯Ø£ ÙŠÙˆÙ… (Ø£Ùˆ ÙƒÙ…Ù„) Ù…Ø¹ Ø³ÙˆÙ‚ Ø¬Ø¯ÙŠØ¯
  startNewDay();
  // ØªÙ†Ù‚Ù„ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
  document.getElementById('loginView').style.display='none';
  document.getElementById('gameView').style.display='flex';
  renderAll();
}

function clearSession(){
  localStorage.removeItem('sessionUser');
  alert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.');
}

function logout(){
  localStorage.removeItem('sessionUser');
  location.reload();
}

// ÙŠØ¨Ø¯Ø£ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯: ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ø³ÙˆÙ‚ØŒ ÙŠÙ†Ø´Ø¦ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ…
function startNewDay(){
  rollNewMarket();
  eventsToday = getDailyEvents();
  currentEvent = null;
  pendingOffer = null;
  renderFooterState();
  logLine(`ğŸ”” Ø¨Ø¯Ø£ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ (${getUser(sessionUser).day}). Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ…: ${eventsToday.length}.`);
  renderAll();
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… Ø«Ù… Ø¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯
function closeDayAndAddIncome(){
  const msg = dailyIncome(sessionUser); // ÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ø±ØµÙŠØ¯ + Ø§Ù„ÙŠÙˆÙ… + Ø§Ù„Ù„ÙˆØ¬
  logLine(`ğŸ“… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… â†’ ${msg}`);
  startNewDay();
  renderAll();
}

// Ø²Ø±Ø§Ø± "Ø¹Ø±Ø¶/Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯"
function triggerNextEvent(){
  if (pendingOffer){ return; } // ÙÙŠ Ø¹Ø±Ø¶ Ù…ÙØªÙˆØ­
  if (eventsToday.length === 0){ closeDayAndAddIncome(); return; }

  // Ø§Ø³Ø­Ø¨ Ø­Ø¯Ø«
  const kind = eventsToday.shift();
  if (kind === 'sell' && getUser(sessionUser).properties.length === 0){
    // Ù…ÙÙŠØ´ Ø­Ø§Ø¬Ø© Ù„Ù„Ø¨ÙŠØ¹ â†’ Ø­ÙˆÙ‘Ù„Ù‡ offer
    currentEvent = {kind: 'offer'};
  } else {
    currentEvent = {kind};
  }

  if (currentEvent.kind === 'offer' || currentEvent.kind === 'auction'){
    // Ø¹Ø±Ø¶ Ø´Ø±Ø§Ø¡ (Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø£Ùˆ Ù…Ø²Ø§Ø¯ Ø¨Ø³Ø¹Ø± Ø£Ù‚Ù„)
    let [msg, data] = getOffer();
    if (currentEvent.kind === 'auction'){
      // Ø®ØµÙ… 10%-40% Ù„Ù„Ù…Ø²Ø§Ø¯
      const disc = randomIn(10,40);
      data.price = Math.floor(data.price * (1 - disc/100));
      msg = `Auction: ${msg.replace('offer:','').trim()} â†’ discounted (${disc}%) â†’ $${data.price}`;
    }
    pendingOffer = {type:'buy', data, text:msg};
    renderOfferBuy(msg, data);
  } else if (currentEvent.kind === 'sell'){
    // Ø¹Ø±Ø¶ Ø¨ÙŠØ¹ Ù…Ù† Ù…Ù…ØªÙ„ÙƒØ§ØªÙƒ
    const user = getUser(sessionUser);
    const item = user.properties[Math.floor(Math.random()*user.properties.length)];
    // Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø­ÙˆØ§Ù„ÙŠÙ† Ù…Ø§ ØªÙ… Ø¥Ù†ÙØ§Ù‚Ù‡ Â±30%
    const baseSpent = Math.max(1, item.spent||100);
    const price = Math.max(1, Math.floor(baseSpent * (1 + (Math.random()*0.6 - 0.3))));
    pendingOffer = {type:'sell', data:{...item, price}, text:`Sell offer: ${describeItem(item)} for $${price}`};
    renderOfferSell(pendingOffer.text, pendingOffer.data);
  }

  renderFooterState();
}

// Ø±Ø³Ù…Ø© ÙˆØµÙ Ø¹Ù†ØµØ±
function describeItem(item){
  if(item.type==='gold') return `Gold ${item.grams||0}g`;
  if(item.type==='company') return `Company ${item.shares||0} shares`;
  if(item.type==='factory') return `Factory cap ${item.capacity||0}`;
  const q = item.quantity || 1;
  return `${item.type} x${q}`;
}

/* ====== Ø¹Ø±Ø¶ Ø´Ø±Ø§Ø¡ ====== */
function renderOfferBuy(text, data){
  const area = document.getElementById('offerArea');
  area.innerHTML = `
    <div class="offer">
      <div style="margin-bottom:8px">${text}</div>
      <div class="stack">
        <button class="btn btn-ok"   onclick="uiAccept()">âœ… Ø§Ø´ØªØ±ÙŠ</button>
        <button class="btn btn-warn" onclick="uiNegotiate()">ğŸ¤ ØªÙØ§ÙˆØ¶ (ÙŠØ´ØªØ±ÙŠ Ø¨Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯)</button>
        <button class="btn btn-bad"  onclick="uiReject()">âŒ Ø±ÙØ¶</button>
      </div>
    </div>
  `;
}

/* ====== Ø¹Ø±Ø¶ Ø¨ÙŠØ¹ Ù…Ù† Ù…Ù…ØªÙ„ÙƒØ§ØªÙƒ ====== */
function renderOfferSell(text, data){
  const area = document.getElementById('offerArea');
  area.innerHTML = `
    <div class="offer">
      <div style="margin-bottom:8px">${text}</div>
      <div class="stack">
        <button class="btn btn-ok"   onclick="uiSellAccept()">âœ… Ø¨ÙŠØ¹</button>
        <button class="btn btn-bad"  onclick="uiReject()">âŒ Ø±ÙØ¶</button>
      </div>
    </div>
  `;
}

/* ====== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ ====== */
function uiAccept(){
  if(!pendingOffer) return;
  if (pendingOffer.type==='buy'){
    const result = handleOffer(sessionUser, pendingOffer.data, 'yes');
    logLine(result);
  }
  afterDecision();
}

function uiNegotiate(){
  if(!pendingOffer) return;
  if (pendingOffer.type==='buy'){
    const result = handleOffer(sessionUser, pendingOffer.data, 'negotiate'); // ÙŠØªÙØ§ÙˆØ¶ Ø«Ù… ÙŠØ´ØªØ±ÙŠ
    logLine(result);
  }
  afterDecision();
}

function uiSellAccept(){
  if(!pendingOffer) return;
  if (pendingOffer.type==='sell'){
    const user = getUser(sessionUser);
    const d = pendingOffer.data;
    // Ø§Ø®ØµÙ…/Ø£Ø¶Ù Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ®Ø±Ù‘Ø¬ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ (Ù„Ùˆ gold Ù‡Ù†Ø¨ÙŠØ¹ ÙƒÙ„Ù‡ ÙƒØ¹Ù†ØµØ± ÙˆØ§Ø­Ø¯)
    user.balance += d.price;
    // Ø£Ù†Ù‚Øµ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© (Ù„Ùˆ quantity>1 Ù‚Ù„Ù‘Ù„Ù‡Ø§)
    let removed = false;
    for (let i=0;i<user.properties.length;i++){
      const it = user.properties[i];
      if (it.type===d.type){
        if (d.type==='gold'){ user.properties.splice(i,1); removed=true; break; }
        if (d.type==='company' || d.type==='factory'){ user.properties.splice(i,1); removed=true; break; }
        // land/property: Ù‚Ù„Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
        if ((it.quantity||1) > 1){ it.quantity -= 1; removed=true; break; }
        else { user.properties.splice(i,1); removed=true; break; }
      }
    }
    if(removed){
      user.event_log.push(`ğŸ’¸ Sold ${describeItem(d)} for $${d.price}`);
      updateUser(sessionUser,user);
      logLine(`Sold successfully. New balance: $${user.balance}`);
    }else{
      logLine(`Sale failed (item not found).`);
    }
  }
  afterDecision();
}

function uiReject(){
  if(!pendingOffer) return;
  const user = getUser(sessionUser);
  user.event_log.push('No action taken.');
  updateUser(sessionUser,user);
  logLine('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¹Ø±Ø¶.');
  afterDecision();
}

function afterDecision(){
  pendingOffer = null;
  document.getElementById('offerArea').innerHTML = '';
  // Ù„Ùˆ Ø®Ù„ØµØª Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ… â†’ Ø¯Ø®Ù€Ù„ ÙŠÙˆÙ…ÙŠ ÙˆÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯
  if (eventsToday.length === 0){ closeDayAndAddIncome(); }
  renderAll();
}

/* ====== Ø¯Ù…Ø¬ Ø§Ù„Ø°Ù‡Ø¨ (UI) ====== */
function mergePropertiesUI(){
  mergeProperties(sessionUser);
  logLine('ğŸ”— ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø°Ù‡Ø¨ ÙÙŠ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯.');
  renderAll();
}

/* =========================
   Ø±Ù†Ø¯Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù€ UI
   ========================= */
function renderAll(){
  renderHeader();
  renderAssets();
  renderLog();
  renderFooterState();
}

function renderHeader(){
  const u = getUser(sessionUser);
  document.getElementById('day').textContent = u.day;
  document.getElementById('balance').textContent = u.balance;
}

function renderAssets(){
  const u = getUser(sessionUser);
  const box = document.getElementById('assetsList');
  const empty = document.getElementById('assetsEmpty');
  box.innerHTML = '';
  if (!u.properties.length){
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  // Ø¹Ø±Ø¶ ÙƒÙ„ Ø£ØµÙ„ Ø¨Ø´ÙƒÙ„ ÙˆØ³Ù… ØµØºÙŠØ±
  u.properties.forEach((p)=>{
    const div = document.createElement('div');
    div.className='pill';
    let txt = '';
    if (p.type==='gold') txt = `Ø°Ù‡Ø¨: ${p.grams||0} ${units.gold}`;
    else if (p.type==='company') txt = `Ø´Ø±ÙƒØ©: ${p.shares||0} ${units.company}`;
    else if (p.type==='factory') txt = `Ù…ØµÙ†Ø¹: Ø³Ø¹Ø© ${p.capacity||0}`;
    else if (p.type==='land') txt = `Ø£Ø±Ø¶: ${p.quantity||1} ${units.land}`;
    else if (p.type==='property') txt = `Ø¹Ù‚Ø§Ø±: ${p.quantity||1} ${units.property}`;
    else if (p.type==='island') txt = `Ø¬Ø²ÙŠØ±Ø©: ${p.quantity||1} ${units.island}`;
    box.appendChild(div);
    div.textContent = txt;
  });
}

function renderLog(){
  const u = getUser(sessionUser);
  const el = document.getElementById('eventLog');
  el.innerHTML = u.event_log.map(x=>`<div>${x}</div>`).join('');
  el.scrollTop = el.scrollHeight;
}

function renderFooterState(){
  document.getElementById('offersLeft').textContent = eventsToday.length;
  document.getElementById('nextEvent').textContent = eventsToday.length ? eventsToday[0] : 'â€”';
  document.getElementById('newEventBtn').textContent = eventsToday.length ? 'Ø¹Ø±Ø¶/Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯' : 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… (Ø¯Ø®Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ)';
}

function renderMarket(){
  const holder = document.getElementById('marketPills');
  holder.innerHTML='';
  Object.entries(market).forEach(([k,v])=>{
    const pill = document.createElement('span');
    pill.className='pill';
    pill.textContent = `${k}: ${v.toFixed(2)}x`;
    holder.appendChild(pill);
  });
}

/* =========================
   ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
   ========================= */
(function init(){
  const sess = localStorage.getItem('sessionUser');
  if (sess){
    sessionUser = sess;
    document.getElementById('loginView').style.display='none';
    document.getElementById('gameView').style.display='flex';
    // Ø§Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    getUser(sessionUser);
    // Ø§Ø¨Ø¯Ø£ ÙŠÙˆÙ… (Ø³ÙˆÙ‚ + Ø£Ø­Ø¯Ø§Ø«)
    startNewDay();
    renderAll();
  }
})();
</script>
</body>
</html>
