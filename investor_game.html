<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لعبة الاستثمار - نسخة الويب</title>
  <style>
    :root{
      --bg:#0f1115; --pane:#171a21; --muted:#8892a6; --fg:#e6edf3; --accent:#3b82f6; --ok:#22c55e; --warn:#eab308; --bad:#ef4444; --card:#1f2430; --line:#2b3242;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans Arabic","Noto Kufi Arabic",Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";}
    .container{display:flex;flex-direction:column;height:100vh}
    .panel{flex:1;min-height:0;padding:16px;border-top:1px solid var(--line)}
    .top{background:var(--pane)}
    .bottom{background:var(--card)}
    @media(min-width:768px){ .container{flex-direction:row} .panel{border-top:none;border-left:1px solid var(--line)} .top{border-left:none}}
    h1,h2,h3{margin:0 0 8px}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#2b3242;color:var(--fg);transition:.15s}
    .btn:hover{filter:brightness(1.1)}
    .btn-primary{background:var(--accent)}
    .btn-ok{background:var(--ok)}
    .btn-warn{background:var(--warn);color:#111}
    .btn-bad{background:var(--bad)}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#12151c;color:var(--fg)}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .card{background:#141821;border:1px solid var(--line);border-radius:14px;padding:12px}
    .offer{background:#121721;border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
    .log{height:220px;overflow:auto;background:#0e121a;border:1px solid var(--line);border-radius:12px;padding:12px;font-size:14px}
    .stat{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:#12171f;border:1px solid var(--line)}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr}
    @media(min-width:768px){.grid-2{grid-template-columns:1fr 1fr}}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f1420;border:1px solid var(--line);font-size:12px;margin:2px 0}
    .footerbar{position:sticky;bottom:0;margin-top:10px;padding:10px;border-top:1px solid var(--line);background:#0b0e14;border-radius:12px}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .kpi .pill{font-weight:600}
    .list{margin:0;padding-inline-start:18px}
  </style>
</head>
<body>

  <!-- شاشة الدخول -->
  <div id="loginView" class="container">
    <div class="panel top">
      <h1>تسجيل الدخول</h1>
      <p class="muted">ادخل اسم المستخدم وكلمة السر (أول مرة بتسجل هتتسجل كلمة السر دي).</p>
      <div class="card grid grid-2">
        <div>
          <label>اسم المستخدم</label>
          <input id="username" placeholder="مثال: joe" />
        </div>
        <div>
          <label>كلمة السر</label>
          <input id="password" type="password" placeholder="••••••" />
        </div>
      </div>
      <div class="stack" style="margin-top:10px">
        <button class="btn btn-primary" onclick="loginFlow()">دخول</button>
        <button class="btn" onclick="clearSession()">مسح الجلسة</button>
      </div>
    </div>
    <div class="panel bottom">
      <h3>ملاحظات</h3>
      <ul class="list muted">
        <li>بياناتك محفوظة محليًا في المتصفح (<code>localStorage</code>).</li>
        <li>ممكن ترجع يومك من غير ما تفقد التقدم.</li>
      </ul>
    </div>
  </div>

  <!-- شاشة اللعبة -->
  <div id="gameView" class="container" style="display:none">
    <!-- معلومات عامة + أصولي -->
    <div class="panel top">
      <h2>أهلًا، <span id="playerName"></span></h2>

      <div class="grid grid-2" style="margin-top:10px">
        <div class="stat">📅 اليوم الحالي: <b id="day" style="margin-inline-start:6px">1</b></div>
        <div class="stat">💰 الرصيد: <b id="balance" style="margin-inline-start:6px">1000</b> $</div>
      </div>

      <div class="card" style="margin-top:10px">
        <h3>📦 أملاكي</h3>
        <div id="assetsEmpty" class="muted">لسه ما اشتريتش حاجة.</div>
        <div id="assetsList"></div>
        <div class="stack" style="margin-top:8px">
          <button class="btn" onclick="mergePropertiesUI()">دمج الذهب</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <h3>📈 حالة السوق اليوم</h3>
        <div id="marketPills" class="kpi"></div>
      </div>

      <div class="footerbar">
        <div class="kpi">
          <span class="pill">العروض المتبقية اليوم: <b id="offersLeft">0</b></span>
          <span class="pill">نوع الحدث التالي: <b id="nextEvent">—</b></span>
        </div>
      </div>
    </div>

    <!-- العروض + اللوج -->
    <div class="panel bottom">
      <div class="stack">
        <button id="newEventBtn" class="btn btn-primary" onclick="triggerNextEvent()">عرض/حدث جديد</button>
        <button class="btn" onclick="logout()">تسجيل خروج</button>
      </div>

      <div id="offerArea"></div>

      <div class="card" style="margin-top:12px">
        <h3>📝 سجل الأحداث</h3>
        <div id="eventLog" class="log"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   تطابق دوال بايثون مع جافاسكريبت
   ========================= */

// units كما في كود البايثون
const units = {
  land: 'meters',
  property: 'units',
  gold: 'grams',
  factory: 'factories',
  company: 'shares',
  island: 'islands'
};

// 1) print_pause -> printPause
function printPause(message, delay=2000){ return message; }

// 2) load_users -> loadUsers (من localStorage)
function loadUsers(){
  try{ return JSON.parse(localStorage.getItem('users')||'{}'); }
  catch{ return {}; }
}

// 3) save_users -> saveUsers
function saveUsers(obj){ localStorage.setItem('users', JSON.stringify(obj)); }

// 4) get_user -> getUser
function getUser(username){
  const users = loadUsers();
  if(!users[username]){
    users[username] = {
      password: null,
      balance: 1000,
      day: 1,
      properties: [],
      event_log: []
    };
    saveUsers(users);
  }
  return users[username];
}

// 5) update_user -> updateUser
function updateUser(username, data){
  const users = loadUsers();
  users[username] = data;
  saveUsers(users);
}

// 6) login(username) في البايثون كانت بتتحقق لو فيه باسورد
function loginUser(username){ 
  const u = getUser(username);
  return u.password ? u : null;
}

// 7) daily_income -> dailyIncome
function dailyIncome(username){
  const user = getUser(username);
  const base_income = 100;
  const bonus = user.properties.length * 50;
  const income = base_income + bonus;
  user.balance += income;
  user.event_log.push(`💰 Daily income: $${income} (Base $${base_income} + $${bonus} bonus)`);
  user.day += 1;
  updateUser(username, user);
  return `Daily income: $${income}. Balance: $${user.balance}`;
}

/* ===== السوق الديناميكي لأسعار مش ميتة ===== */
const market = {
  land: 1, property: 1, gold: 1, factory: 1, company: 1, island: 1
};
function randomIn(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function vary(f, pct=0.2){ // ±20%
  const delta = (Math.random()*2-1)*pct;
  return Math.max(0.6, Math.min(1.6, f*(1+delta)));
}
function rollNewMarket(){
  // كل يوم عامل جديد للسوق
  market.land = vary(market.land);
  market.property = vary(market.property);
  market.gold = vary(market.gold, 0.3);
  market.factory = vary(market.factory);
  market.company = vary(market.company, 0.25);
  market.island = vary(market.island, 0.15);
  renderMarket();
}

/* 8) get_offer -> getOffer (ترجع msg + data) */
function getOffer(){
  const types = ['land','property','gold','factory','company','island'];
  const ttype = types[Math.floor(Math.random()*types.length)];
  if (ttype === 'land'){
    const price = randomIn(100,500) * market.land;
    return [`Land offer: Buy 1 plot for $${Math.floor(price)}`, {type:ttype, price:Math.floor(price)}];
  }
  if (ttype === 'property'){
    const price = randomIn(500,2000) * market.property;
    return [`Property offer: Buy 1 unit for $${Math.floor(price)}`, {type:ttype, price:Math.floor(price)}];
  }
  if (ttype === 'gold'){
    const grams = randomIn(10,100);
    const ppg = randomIn(50,100) * market.gold;
    const total = Math.floor(grams * ppg);
    return [`Gold offer: ${grams}g at $${Math.floor(ppg)}/g for total $${total}`, {type:'gold', grams, price_per_gram:Math.floor(ppg), price:total}];
  }
  if (ttype === 'factory'){
    const capacity = randomIn(1,5);
    const price = Math.floor(capacity * randomIn(1000,5000) * market.factory);
    return [`Factory offer: capacity ${capacity} for $${price}`, {type:ttype, capacity, price}];
  }
  if (ttype === 'company'){
    const shares = randomIn(10,50);
    const pps = Math.floor(randomIn(200,500) * market.company);
    const total = shares * pps;
    return [`Company offer: ${shares} shares at $${pps}/share for total $${total}`, {type:ttype, shares, price_per_share:pps, price:total}];
  }
  // island
  const size = ['small','medium','large'][Math.floor(Math.random()*3)];
  const mult = {small:500, medium:2000, large:5000}[size];
  const price = Math.floor(mult * randomIn(1,3) * market.island);
  return [`Island offer: Buy a ${size} island for $${price}`, {type:'island', size, price}];
}

/* 9) merge_properties -> mergeProperties */
function mergeProperties(username){
  const user = getUser(username);
  const merged = [];
  let gold_total = 0, gold_spent = 0;
  for(const item of user.properties){
    if(item.type==='gold'){
      gold_total += item.grams||0;
      gold_spent += item.spent||0;
    }else{
      merged.push(item);
    }
  }
  if(gold_total){
    merged.push({type:'gold', grams:gold_total, spent:gold_spent});
  }
  user.properties = merged;
  updateUser(username, user);
}

/* 10) handle_offer -> handleOffer (تتوافق مع منطقك بما فيه التفاوض=شراء بسعر مخفّض) */
function handleOffer(username, data, choice){
  const user = getUser(username);
  let price = data.price;
  if (choice === 'negotiate'){
    const new_price = Math.floor(price * (1 - randomIn(5,30)/100));
    choice = 'yes';
    price = new_price;
    user.event_log.push(`🤝 Negotiated price to $${price}`);
  }
  if (choice === 'yes'){
    if (user.balance >= price){
      user.balance -= price;
      let exists = false;
      for (const item of user.properties){
        if (item.type === data.type){
          if (data.type === 'gold') item.grams = (item.grams||0) + (data.grams||0);
          else if (data.type === 'company') item.shares = (item.shares||0) + (data.shares||0);
          else if (data.type === 'factory') item.capacity = (item.capacity||0) + (data.capacity||0);
          else item.quantity = (item.quantity||0) + 1;
          item.spent = (item.spent||0) + price;
          exists = true;
        }
      }
      if(!exists){
        const entry = {type:data.type, spent:price};
        if (data.type==='gold') entry.grams = data.grams;
        else if (data.type==='company') entry.shares = data.shares;
        else if (data.type==='factory') entry.capacity = data.capacity;
        else entry.quantity = 1;
        user.properties.push(entry);
      }
      user.event_log.push(`✅ Bought ${data.type} for $${price}`);
      updateUser(username, user);
      return `Purchased! New balance: $${user.balance}`;
    }else{
      user.event_log.push(`❌ You don't have enough balance.`);
      updateUser(username, user);
      return `You don't have enough balance.`;
    }
  }else{
    user.event_log.push(`🚫 No purchase made.`);
    updateUser(username, user);
    return `No purchase made.`;
  }
}

/* 11) get_daily_events -> getDailyEvents */
function getDailyEvents(){
  const count = randomIn(2,5);
  const types = ['offer','sell','auction'];
  const out = [];
  for(let i=0;i<count;i++){
    out.push(types[randomIn(0,types.length-1)]);
  }
  return out;
}

/* =========================
   واجهة وإدارة اليوم/الأحداث
   ========================= */

let sessionUser = null;
let eventsToday = [];   // قائمة أحداث اليوم
let currentEvent = null;// { kind:'offer'|'sell'|'auction', payload:{} }
let pendingOffer = null;// بيانات العرض الحالي (للشراء/التفاوض/الرفض)

function loginFlow(){
  const uname = document.getElementById('username').value.trim();
  const pass  = document.getElementById('password').value;
  if(!uname){ alert('اكتب اسم المستخدم'); return; }

  let u = getUser(uname); // يرجع user أو ينشئ واحد جديد
  if(u.password && u.password !== pass){ 
    alert('كلمة السر غير صحيحة'); 
    return; 
  }

  if(!u.password){ 
    u.password = pass; 
    updateUser(uname, u); 
  }

  sessionUser = uname;
  localStorage.setItem('sessionUser', uname);

  // 👇 اتأكد أن البيانات اتحدثت من localStorage قبل ما تفتح اللعبة
  u = getUser(uname);

  showGame();
}


function showGame(){
  // استرجاع المستخدم + إعداد يوم جديد لو لسه مفيش
  const u = getUser(sessionUser);
  document.getElementById('playerName').textContent = sessionUser;

  // ابدأ يوم (أو كمل) مع سوق جديد
  startNewDay();
  // تنقل للواجهة
  document.getElementById('loginView').style.display='none';
  document.getElementById('gameView').style.display='flex';
  renderAll();
}

function clearSession(){
  localStorage.removeItem('sessionUser');
  alert('تم مسح الجلسة الحالية فقط. البيانات محفوظة.');
}

function logout(){
  localStorage.removeItem('sessionUser');
  location.reload();
}

// يبدأ يوم جديد: يغيّر السوق، ينشئ أحداث اليوم
function startNewDay(){
  rollNewMarket();
  eventsToday = getDailyEvents();
  currentEvent = null;
  pendingOffer = null;
  renderFooterState();
  logLine(`🔔 بدأ يوم جديد (${getUser(sessionUser).day}). أحداث اليوم: ${eventsToday.length}.`);
  renderAll();
}

// تنفيذ الدخل اليومي وإنهاء اليوم ثم بدء يوم جديد
function closeDayAndAddIncome(){
  const msg = dailyIncome(sessionUser); // يحدّث الرصيد + اليوم + اللوج
  logLine(`📅 نهاية اليوم → ${msg}`);
  startNewDay();
  renderAll();
}

// زرار "عرض/حدث جديد"
function triggerNextEvent(){
  if (pendingOffer){ return; } // في عرض مفتوح
  if (eventsToday.length === 0){ closeDayAndAddIncome(); return; }

  // اسحب حدث
  const kind = eventsToday.shift();
  if (kind === 'sell' && getUser(sessionUser).properties.length === 0){
    // مفيش حاجة للبيع → حوّله offer
    currentEvent = {kind: 'offer'};
  } else {
    currentEvent = {kind};
  }

  if (currentEvent.kind === 'offer' || currentEvent.kind === 'auction'){
    // عرض شراء (العادي أو مزاد بسعر أقل)
    let [msg, data] = getOffer();
    if (currentEvent.kind === 'auction'){
      // خصم 10%-40% للمزاد
      const disc = randomIn(10,40);
      data.price = Math.floor(data.price * (1 - disc/100));
      msg = `Auction: ${msg.replace('offer:','').trim()} → discounted (${disc}%) → $${data.price}`;
    }
    pendingOffer = {type:'buy', data, text:msg};
    renderOfferBuy(msg, data);
  } else if (currentEvent.kind === 'sell'){
    // عرض بيع من ممتلكاتك
    const user = getUser(sessionUser);
    const item = user.properties[Math.floor(Math.random()*user.properties.length)];
    // سعر البيع حوالين ما تم إنفاقه ±30%
    const baseSpent = Math.max(1, item.spent||100);
    const price = Math.max(1, Math.floor(baseSpent * (1 + (Math.random()*0.6 - 0.3))));
    pendingOffer = {type:'sell', data:{...item, price}, text:`Sell offer: ${describeItem(item)} for $${price}`};
    renderOfferSell(pendingOffer.text, pendingOffer.data);
  }

  renderFooterState();
}

// رسمة وصف عنصر
function describeItem(item){
  if(item.type==='gold') return `Gold ${item.grams||0}g`;
  if(item.type==='company') return `Company ${item.shares||0} shares`;
  if(item.type==='factory') return `Factory cap ${item.capacity||0}`;
  const q = item.quantity || 1;
  return `${item.type} x${q}`;
}

/* ====== عرض شراء ====== */
function renderOfferBuy(text, data){
  const area = document.getElementById('offerArea');
  area.innerHTML = `
    <div class="offer">
      <div style="margin-bottom:8px">${text}</div>
      <div class="stack">
        <button class="btn btn-ok"   onclick="uiAccept()">✅ اشتري</button>
        <button class="btn btn-warn" onclick="uiNegotiate()">🤝 تفاوض (يشتري بالسعر الجديد)</button>
        <button class="btn btn-bad"  onclick="uiReject()">❌ رفض</button>
      </div>
    </div>
  `;
}

/* ====== عرض بيع من ممتلكاتك ====== */
function renderOfferSell(text, data){
  const area = document.getElementById('offerArea');
  area.innerHTML = `
    <div class="offer">
      <div style="margin-bottom:8px">${text}</div>
      <div class="stack">
        <button class="btn btn-ok"   onclick="uiSellAccept()">✅ بيع</button>
        <button class="btn btn-bad"  onclick="uiReject()">❌ رفض</button>
      </div>
    </div>
  `;
}

/* ====== أزرار التفاعل مع العروض ====== */
function uiAccept(){
  if(!pendingOffer) return;
  if (pendingOffer.type==='buy'){
    const result = handleOffer(sessionUser, pendingOffer.data, 'yes');
    logLine(result);
  }
  afterDecision();
}

function uiNegotiate(){
  if(!pendingOffer) return;
  if (pendingOffer.type==='buy'){
    const result = handleOffer(sessionUser, pendingOffer.data, 'negotiate'); // يتفاوض ثم يشتري
    logLine(result);
  }
  afterDecision();
}

function uiSellAccept(){
  if(!pendingOffer) return;
  if (pendingOffer.type==='sell'){
    const user = getUser(sessionUser);
    const d = pendingOffer.data;
    // اخصم/أضف الرصيد وخرّج عنصر واحد (لو gold هنبيع كله كعنصر واحد)
    user.balance += d.price;
    // أنقص الملكية المقابلة (لو quantity>1 قلّلها)
    let removed = false;
    for (let i=0;i<user.properties.length;i++){
      const it = user.properties[i];
      if (it.type===d.type){
        if (d.type==='gold'){ user.properties.splice(i,1); removed=true; break; }
        if (d.type==='company' || d.type==='factory'){ user.properties.splice(i,1); removed=true; break; }
        // land/property: قلل الكمية
        if ((it.quantity||1) > 1){ it.quantity -= 1; removed=true; break; }
        else { user.properties.splice(i,1); removed=true; break; }
      }
    }
    if(removed){
      user.event_log.push(`💸 Sold ${describeItem(d)} for $${d.price}`);
      updateUser(sessionUser,user);
      logLine(`Sold successfully. New balance: $${user.balance}`);
    }else{
      logLine(`Sale failed (item not found).`);
    }
  }
  afterDecision();
}

function uiReject(){
  if(!pendingOffer) return;
  const user = getUser(sessionUser);
  user.event_log.push('No action taken.');
  updateUser(sessionUser,user);
  logLine('تم رفض العرض.');
  afterDecision();
}

function afterDecision(){
  pendingOffer = null;
  document.getElementById('offerArea').innerHTML = '';
  // لو خلصت أحداث اليوم → دخـل يومي ويوم جديد
  if (eventsToday.length === 0){ closeDayAndAddIncome(); }
  renderAll();
}

/* ====== دمج الذهب (UI) ====== */
function mergePropertiesUI(){
  mergeProperties(sessionUser);
  logLine('🔗 تم دمج الذهب في عنصر واحد.');
  renderAll();
}

/* =========================
   رندر الحالة والـ UI
   ========================= */
function renderAll(){
  renderHeader();
  renderAssets();
  renderLog();
  renderFooterState();
}

function renderHeader(){
  const u = getUser(sessionUser);
  document.getElementById('day').textContent = u.day;
  document.getElementById('balance').textContent = u.balance;
}

function renderAssets(){
  const u = getUser(sessionUser);
  const box = document.getElementById('assetsList');
  const empty = document.getElementById('assetsEmpty');
  box.innerHTML = '';
  if (!u.properties.length){
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  // عرض كل أصل بشكل وسم صغير
  u.properties.forEach((p)=>{
    const div = document.createElement('div');
    div.className='pill';
    let txt = '';
    if (p.type==='gold') txt = `ذهب: ${p.grams||0} ${units.gold}`;
    else if (p.type==='company') txt = `شركة: ${p.shares||0} ${units.company}`;
    else if (p.type==='factory') txt = `مصنع: سعة ${p.capacity||0}`;
    else if (p.type==='land') txt = `أرض: ${p.quantity||1} ${units.land}`;
    else if (p.type==='property') txt = `عقار: ${p.quantity||1} ${units.property}`;
    else if (p.type==='island') txt = `جزيرة: ${p.quantity||1} ${units.island}`;
    box.appendChild(div);
    div.textContent = txt;
  });
}

function renderLog(){
  const u = getUser(sessionUser);
  const el = document.getElementById('eventLog');
  el.innerHTML = u.event_log.map(x=>`<div>${x}</div>`).join('');
  el.scrollTop = el.scrollHeight;
}

function renderFooterState(){
  document.getElementById('offersLeft').textContent = eventsToday.length;
  document.getElementById('nextEvent').textContent = eventsToday.length ? eventsToday[0] : '—';
  document.getElementById('newEventBtn').textContent = eventsToday.length ? 'عرض/حدث جديد' : 'إنهاء اليوم (دخل تلقائي)';
}

function renderMarket(){
  const holder = document.getElementById('marketPills');
  holder.innerHTML='';
  Object.entries(market).forEach(([k,v])=>{
    const pill = document.createElement('span');
    pill.className='pill';
    pill.textContent = `${k}: ${v.toFixed(2)}x`;
    holder.appendChild(pill);
  });
}

/* =========================
   تهيئة عند الفتح
   ========================= */
(function init(){
  const sess = localStorage.getItem('sessionUser');
  if (sess){
    sessionUser = sess;
    document.getElementById('loginView').style.display='none';
    document.getElementById('gameView').style.display='flex';
    // اضمن وجود المستخدم
    getUser(sessionUser);
    // ابدأ يوم (سوق + أحداث)
    startNewDay();
    renderAll();
  }
})();
</script>
</body>
</html>
