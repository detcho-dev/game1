<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Economy Game</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
    h1, h2 { text-align: center; }
    .result { margin-top: 15px; padding: 10px; background: #eef; border-radius: 5px; }
    button { margin: 5px; padding: 8px 15px; cursor: pointer; }
    .properties, .log { margin-top: 20px; }
    ul { list-style-type: none; padding: 0; }
    li { margin: 3px 0; }
    .login { text-align: center; }
  </style>
</head>
<body>
<div class="container" id="app">
  <!-- Login -->
  <div id="loginScreen" class="login">
    <h1>Login</h1>
    <input type="text" id="username" placeholder="Username"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login / Register</button>
    <div id="loginMsg"></div>
  </div>

  <!-- Game -->
  <div id="gameScreen" style="display:none;">
    <h1>Economy Game</h1>
    <p><b>User:</b> <span id="userName"></span></p>
    <p><b>Balance:</b> <span id="balance"></span></p>
    <p><b>Day:</b> <span id="day"></span></p>

    <button onclick="nextDay()">Next Day</button>
    <div id="dailyEvents" class="result"></div>

    <div id="result" class="result"></div>

    <div class="properties">
      <h2>Properties</h2>
      <ul id="propertiesList"></ul>
    </div>

    <div class="log">
      <h2>Event Log</h2>
      <ul id="eventLog"></ul>
    </div>
  </div>
</div>

<script>
// ====================== Utils ======================
function formatMoney(amount) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
}

function loadUsers() {
  return JSON.parse(localStorage.getItem("users") || "{}");
}

function saveUsers(users) {
  localStorage.setItem("users", JSON.stringify(users));
}

function getUser(username) {
  let users = loadUsers();
  if (!users[username]) {
    users[username] = {
      password: null,
      balance: 1000,
      day: 1,
      properties: [],
      event_log: []
    };
    saveUsers(users);
  }
  return users[username];
}

function updateUser(username, data) {
  let users = loadUsers();
  users[username] = data;
  saveUsers(users);
}

function mergeGold(user) {
  let goldTotal = 0;
  let others = [];
  user.properties.forEach(p => {
    if (p.type === "gold") goldTotal += p.grams;
    else others.push(p);
  });
  if (goldTotal > 0) {
    others.push({ type: "gold", grams: goldTotal, spent: 0 });
  }
  user.properties = others;
  return user;
}

// ====================== Login ======================
let currentUser = null;

function login() {
  let username = document.getElementById("username").value.trim();
  let password = document.getElementById("password").value.trim();
  if (!username || !password) {
    document.getElementById("loginMsg").innerText = "Enter username and password!";
    return;
  }
  let user = getUser(username);

  if (user.password && user.password !== password) {
    document.getElementById("loginMsg").innerText = "Invalid password!";
    return;
  }
  if (!user.password) {
    user.password = password;
    updateUser(username, user);
  }

  currentUser = username;
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";
  render();
}

// ====================== Game Logic ======================
function dailyIncome(user) {
  let base_income = 100;
  let bonus = user.properties.length * 50;
  let income = base_income + bonus;
  user.balance += income;
  user.event_log.push(`Day ${user.day}: Daily income ${formatMoney(income)} (Base ${formatMoney(base_income)} + ${formatMoney(bonus)} bonus)`);
  return user;
}

function getOffer() {
  let types = ["land", "property", "gold", "factory", "company", "island"];
  let ttype = types[Math.floor(Math.random() * types.length)];
  let data = {};
  let msg = "";

  if (ttype === "land") {
    let price = Math.floor(Math.random() * (500 - 100 + 1)) + 100;
    msg = `Land offer: Buy 1 plot for ${formatMoney(price)}`;
    data = { type: "land", price };
  }
  else if (ttype === "property") {
    let price = Math.floor(Math.random() * (2000 - 500 + 1)) + 500;
    msg = `Property offer: Buy 1 unit for ${formatMoney(price)}`;
    data = { type: "property", price };
  }
  else if (ttype === "gold") {
    let grams = Math.floor(Math.random() * (100 - 10 + 1)) + 10;
    let ppg = Math.floor(Math.random() * (100 - 50 + 1)) + 50;
    let total = grams * ppg;
    msg = `Gold offer: ${grams}g at ${formatMoney(ppg)}/g for total ${formatMoney(total)}`;
    data = { type: "gold", grams, price_per_gram: ppg, price: total };
  }
  else if (ttype === "factory") {
    let capacity = Math.floor(Math.random() * 5) + 1;
    let price = capacity * (Math.floor(Math.random() * (5000 - 1000 + 1)) + 1000);
    msg = `Factory offer: Buy factory with capacity ${capacity} for ${formatMoney(price)}`;
    data = { type: "factory", capacity, price };
  }
  else if (ttype === "company") {
    let shares = Math.floor(Math.random() * (50 - 10 + 1)) + 10;
    let price_per_share = Math.floor(Math.random() * (500 - 200 + 1)) + 200;
    let total = shares * price_per_share;
    msg = `Company offer: ${shares} shares at ${formatMoney(price_per_share)}/share for total ${formatMoney(total)}`;
    data = { type: "company", shares, price_per_share, price: total };
  }
  else { // island
    let sizes = ["small", "medium", "large"];
    let size = sizes[Math.floor(Math.random() * sizes.length)];
    let multiplier = { small: 500, medium: 2000, large: 5000 }[size];
    let price = multiplier * (Math.floor(Math.random() * 3) + 1);
    msg = `Island offer: Buy a ${size} island for ${formatMoney(price)}`;
    data = { type: "island", size, price };
  }

  return { msg, data };
}

function handleOffer(data, choice) {
  let user = getUser(currentUser);
  let price = data.price;

  if (choice === "negotiate") {
    let discount = Math.floor(Math.random() * (30 - 5 + 1)) + 5;
    price = Math.floor(price * (1 - discount / 100));
    choice = "yes";
  }

  if (choice === "yes") {
    if (user.balance >= price) {
      user.balance -= price;
      let exists = false;

      user.properties.forEach(item => {
        if (item.type === data.type) {
          if (data.type === "gold") item.grams += data.grams;
          else if (data.type === "company") item.shares = (item.shares || 0) + data.shares;
          else if (data.type === "factory") item.capacity = (item.capacity || 0) + data.capacity;
          else item.quantity = (item.quantity || 0) + 1;
          item.spent += price;
          exists = true;
        }
      });

      if (!exists) {
        let entry = { type: data.type, spent: price };
        if (data.type === "gold") entry.grams = data.grams;
        else if (data.type === "company") entry.shares = data.shares;
        else if (data.type === "factory") entry.capacity = data.capacity;
        else entry.quantity = 1;
        user.properties.push(entry);
      }

      user.event_log.push(`Bought ${data.type} for ${formatMoney(price)}`);
      updateUser(currentUser, user);
      render(`Purchased! New balance: ${formatMoney(user.balance)}`);
    } else {
      render("You don't have enough balance.");
    }
  } else {
    render("No purchase made.");
  }
}

function sellProperty(index) {
  let user = getUser(currentUser);
  if (index >= 0 && index < user.properties.length) {
    let item = user.properties[index];
    let value = Math.floor((item.spent || 100) * 0.6); // 60% back
    user.balance += value;
    user.event_log.push(`Sold ${item.type} for ${formatMoney(value)}`);
    user.properties.splice(index, 1);
    updateUser(currentUser, user);
    render(`Sold property for ${formatMoney(value)}.`);
  }
}

function auctionEvent() {
  let { msg, data } = getOffer();
  let user = getUser(currentUser);
  let startPrice = Math.floor(data.price * 0.5);
  let bid = Math.floor(startPrice + Math.random() * (data.price * 0.4));
  return {
    msg: `Auction! ${msg} (starting at ${formatMoney(startPrice)}). Current highest bid: ${formatMoney(bid)}.`,
    data: data,
    startPrice: startPrice,
    bid: bid
  };
}

function joinAuction(data, bid) {
  let user = getUser(currentUser);
  if (user.balance >= bid) {
    user.balance -= bid;
    user.properties.push({ type: data.type, spent: bid, quantity: 1 });
    user.event_log.push(`Won auction for ${data.type} at ${formatMoney(bid)}`);
    updateUser(currentUser, user);
    render(`Auction won! Paid ${formatMoney(bid)}`);
  } else {
    render("Not enough money to join auction.");
  }
}

// ====================== Daily Events ======================
function getDailyEvents() {
  let events = [];
  let num = Math.floor(Math.random() * (5 - 2 + 1)) + 2;
  for (let i = 0; i < num; i++) {
    let choice = ["offer", "sell", "auction"][Math.floor(Math.random() * 3)];
    events.push(choice);
  }
  return events;
}

function nextDay() {
  let user = getUser(currentUser);
  user.day += 1;
  user = dailyIncome(user);
  user = mergeGold(user);

  let events = getDailyEvents();
  let output = "";
  events.forEach(e => {
    if (e === "offer") {
      let { msg, data } = getOffer();
      output += `<p>${msg}</p>
        <button onclick='handleOffer(${JSON.stringify(data)}, "yes")'>Buy</button>
        <button onclick='handleOffer(${JSON.stringify(data)}, "negotiate")'>Negotiate</button>
        <button onclick='handleOffer(${JSON.stringify(data)}, "no")'>Reject</button>`;
    }
    if (e === "sell" && user.properties.length > 0) {
      user.properties.forEach((p, idx) => {
        output += `<p>Sell offer: Sell your ${p.type} for 60% value</p>
        <button onclick='sellProperty(${idx})'>Sell ${p.type}</button>`;
      });
    }
    if (e === "auction") {
      let auc = auctionEvent();
      output += `<p>${auc.msg}</p>
        <button onclick='joinAuction(${JSON.stringify(auc.data)}, ${auc.bid})'>Join Auction</button>`;
    }
  });

  updateUser(currentUser, user);
  document.getElementById("dailyEvents").innerHTML = output;
  render(`Day ${user.day} started.`);
}

// ====================== Render ======================
function render(extraMsg="") {
  let user = getUser(currentUser);
  document.getElementById("userName").innerText = currentUser;
  document.getElementById("balance").innerText = formatMoney(user.balance);
  document.getElementById("day").innerText = user.day;

  let propList = document.getElementById("propertiesList");
  propList.innerHTML = "";
  user.properties.forEach((p, i) => {
    let li = document.createElement("li");
    li.textContent = JSON.stringify(p);
    propList.appendChild(li);
  });

  let logList = document.getElementById("eventLog");
  logList.innerHTML = "";
  user.event_log.slice(-15).reverse().forEach(ev => {
    let li = document.createElement("li");
    li.textContent = ev;
    logList.appendChild(li);
  });

  if (extraMsg) document.getElementById("result").innerText = extraMsg;
}
</script>
</body>
</html>
