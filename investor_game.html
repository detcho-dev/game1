<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Economy Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    .card { background: white; border-radius: 8px; padding: 20px; margin: 10px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h1,h2,h3 { margin-top: 0; }
    input, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    ul { padding-left: 20px; }
    .flex { display: flex; flex-wrap: wrap; gap: 10px; }
    .btn { flex: 1; min-width: 120px; text-align: center; }
    .hidden { display: none; }
    @media(max-width:600px){ .flex { flex-direction: column; } }
  </style>
</head>
<body>
<div class="container">
  <!-- Login Screen -->
  <div id="loginScreen" class="card">
    <h1>Login</h1>
    <input type="text" id="username" placeholder="Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login / Register</button>
    <p id="loginMsg"></p>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="hidden">
    <div class="card">
      <h1>Economy Game</h1>
      <p><b>User:</b> <span id="userName"></span></p>
      <p><b>Day:</b> <span id="day"></span></p>
      <p><b>Balance:</b> <span id="balance"></span></p>
      <div class="flex">
        <button class="btn" onclick="nextDay()">Next Day</button>
        <button class="btn" onclick="dailyIncome()">Collect Daily Income</button>
        <button class="btn" onclick="showOffer()">Get Offer</button>
      </div>
    </div>

    <div class="card">
      <h2>Result</h2>
      <div id="result"></div>
    </div>

    <div class="card">
      <h2>Properties</h2>
      <ul id="propertiesList"></ul>
    </div>

    <div class="card">
      <h2>Event Log</h2>
      <ul id="eventLog"></ul>
    </div>
  </div>
</div>

<script>
// ====== Utils ======
function formatMoney(amount){
  return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(amount);
}
function loadUsers(){ return JSON.parse(localStorage.getItem("users")||"{}"); }
function saveUsers(users){ localStorage.setItem("users",JSON.stringify(users)); }
function getUser(username){
  let users=loadUsers();
  if(!users[username]){
    users[username]={password:null,balance:1000,day:1,properties:[],event_log:[]};
    saveUsers(users);
  }
  return users[username];
}
function updateUser(username,data){ let users=loadUsers(); users[username]=data; saveUsers(users); }

// ====== Login ======
let currentUser=null;
function login(){
  let username=document.getElementById("username").value.trim();
  let password=document.getElementById("password").value.trim();
  if(!username||!password){ document.getElementById("loginMsg").innerText="Enter username and password"; return; }
  let users=loadUsers(); let user=getUser(username);
  if(user.password&&user.password!==password){ document.getElementById("loginMsg").innerText="Invalid password"; return; }
  if(!user.password){ user.password=password; updateUser(username,user); }
  currentUser=username;
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("gameScreen").classList.remove("hidden");
  render();
}

// ====== Game Logic ======
function dailyIncome(){
  let user=getUser(currentUser);
  let base=100; let bonus=user.properties.length*50;
  let income=base+bonus;
  user.balance+=income;
  user.event_log.push(`Daily income: ${formatMoney(income)} (Base ${formatMoney(base)} + Bonus ${formatMoney(bonus)})`);
  updateUser(currentUser,user);
  render(`Collected daily income: ${formatMoney(income)}`);
}
function getOffer(){
  let types=["land","property","gold","factory","company","island"];
  let ttype=types[Math.floor(Math.random()*types.length)];
  let data={}; let msg="";
  if(ttype==="land"){ let price=rand(100,500); msg=`Land: Buy 1 plot for ${formatMoney(price)}`; data={type:"land",price}; }
  else if(ttype==="property"){ let price=rand(500,2000); msg=`Property: Buy 1 unit for ${formatMoney(price)}`; data={type:"property",price}; }
  else if(ttype==="gold"){ let grams=rand(10,100); let ppg=rand(50,100); let total=grams*ppg; msg=`Gold: ${grams}g at ${formatMoney(ppg)}/g = ${formatMoney(total)}`; data={type:"gold",grams,price_per_gram:ppg,price:total}; }
  else if(ttype==="factory"){ let cap=rand(1,5); let price=cap*rand(1000,5000); msg=`Factory: Capacity ${cap} for ${formatMoney(price)}`; data={type:"factory",capacity:cap,price}; }
  else if(ttype==="company"){ let shares=rand(10,50); let pps=rand(200,500); let total=shares*pps; msg=`Company: ${shares} shares at ${formatMoney(pps)} = ${formatMoney(total)}`; data={type:"company",shares,price_per_share:pps,price:total}; }
  else { let sizes=["small","medium","large"]; let size=sizes[rand(0,2)]; let mult={small:500,medium:2000,large:5000}[size]; let price=mult*rand(1,3); msg=`Island: ${size} for ${formatMoney(price)}`; data={type:"island",size,price}; }
  return {msg,data};
}
function handleOffer(data,choice){
  let user=getUser(currentUser); let price=data.price;
  if(choice==="negotiate"){ let disc=rand(5,30); price=Math.floor(price*(1-disc/100)); choice="yes"; }
  if(choice==="yes"){
    if(user.balance>=price){
      user.balance-=price; let exists=false;
      user.properties.forEach(it=>{ if(it.type===data.type){ exists=true;
        if(data.type==="gold") it.grams+=data.grams;
        else if(data.type==="company") it.shares=(it.shares||0)+data.shares;
        else if(data.type==="factory") it.capacity=(it.capacity||0)+data.capacity;
        else it.quantity=(it.quantity||0)+1;
        it.spent+=price; }});
      if(!exists){ let entry={type:data.type,spent:price};
        if(data.type==="gold") entry.grams=data.grams;
        else if(data.type==="company") entry.shares=data.shares;
        else if(data.type==="factory") entry.capacity=data.capacity;
        else entry.quantity=1;
        user.properties.push(entry);
      }
      user.event_log.push(`Bought ${data.type} for ${formatMoney(price)}`);
      updateUser(currentUser,user);
      render(`Purchased ${data.type}!`);
    } else render("Not enough balance");
  } else render("Rejected offer");
}
function showOffer(){
  let {msg,data}=getOffer();
  document.getElementById("result").innerHTML=
    `<p>${msg}</p>
     <div class="flex">
       <button class="btn" onclick='handleOffer(${JSON.stringify(data)},"yes")'>Buy</button>
       <button class="btn" onclick='handleOffer(${JSON.stringify(data)},"negotiate")'>Negotiate</button>
       <button class="btn" onclick='handleOffer(${JSON.stringify(data)},"no")'>Reject</button>
     </div>`;
}
// Sell property
function sellProperty(index){
  let user=getUser(currentUser);
  let item=user.properties[index];
  let value=Math.floor(item.spent*0.7);
  user.balance+=value;
  user.event_log.push(`Sold ${item.type} for ${formatMoney(value)}`);
  user.properties.splice(index,1);
  updateUser(currentUser,user);
  render(`Sold ${item.type} for ${formatMoney(value)}`);
}
// Auction event
function startAuction(){
  let price=rand(500,2000);
  document.getElementById("result").innerHTML=
    `<p>Auction starting at ${formatMoney(price)}. Do you bid?</p>
     <div class="flex">
       <button class="btn" onclick="auctionBid(${price})">Bid</button>
       <button class="btn" onclick="render('Skipped auction')">Skip</button>
     </div>`;
}
function auctionBid(price){
  let user=getUser(currentUser);
  let final=price+rand(100,500);
  if(user.balance>=final){
    user.balance-=final;
    user.properties.push({type:"auction_item",spent:final,quantity:1});
    user.event_log.push(`Won auction for ${formatMoney(final)}`);
    updateUser(currentUser,user);
    render(`You won auction for ${formatMoney(final)}`);
  } else render("Not enough balance to bid");
}
// Daily events
function nextDay(){
  let user=getUser(currentUser); user.day+=1; updateUser(currentUser,user);
  let events=["offer","sell","auction"]; let ev=events[rand(0,2)];
  if(ev==="offer") showOffer();
  else if(ev==="sell"){ if(user.properties.length){ let idx=rand(0,user.properties.length-1); sellProperty(idx); } else render("No properties to sell today"); }
  else if(ev==="auction") startAuction();
  render(`Day advanced to ${user.day}`);
}
// ====== Helpers ======
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
// ====== Render ======
function render(extra=""){
  let user=getUser(currentUser);
  document.getElementById("userName").innerText=currentUser;
  document.getElementById("balance").innerText=formatMoney(user.balance);
  document.getElementById("day").innerText=user.day;
  let props=document.getElementById("propertiesList"); props.innerHTML="";
  user.properties.forEach((p,i)=>{ let li=document.createElement("li");
    li.innerHTML=JSON.stringify(p)+` <button onclick="sellProperty(${i})">Sell</button>`; props.appendChild(li); });
  let logs=document.getElementById("eventLog"); logs.innerHTML="";
  user.event_log.slice(-10).reverse().forEach(ev=>{ let li=document.createElement("li"); li.textContent=ev; logs.appendChild(li); });
  if(extra) document.getElementById("result").innerText=extra;
}
</script>
</body>
</html>
